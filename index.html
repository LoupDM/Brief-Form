<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Plan Template</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/i1gr13bjn04mkseuam1j1to4hcw5tg0thbu31wrkx79s9t2f/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body {
            background-color: #f0f4f8;
            color: #333;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        h1 {
            color: #2c5282;
            border-bottom: 2px solid #2c5282;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        label {
            color: #2c5282;
            font-weight: 600;
        }
        input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            margin-top: 0.25rem;
        }
        button {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        button:hover {
            opacity: 0.9;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #cbd5e0;
            padding: 0.5rem;
        }
        th {
            background-color: #edf2f7;
            font-weight: 600;
            text-align: left;
        }
        .delete-task {
            background-color: #f56565;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .delete-task:hover {
            background-color: #e53e3e;
        }
        .task-toolbar {
            display: none;
            padding: 0.5rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .task-toolbar.visible {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .task-checkbox {
            width: 1.2rem;
            height: 1.2rem;
            margin-right: 0.5rem;
        }
        .selected-row {
            background-color: #e2e8f0;
        }
        .toolbar-button {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            color: white;
            cursor: pointer;
        }
        .toolbar-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
.task-drag-handle {
    cursor: move;
    padding: 2px 5px;
    margin: 0;
    background-color: #e2e8f0;
    border-radius: 4px;
    display: inline-block;
}
        .task-drag-handle:hover {
            background-color: #cbd5e0;
        }
        .tox-tinymce {
    border-radius: 4px !important;
    border-color: #cbd5e0 !important;
}

.mce-content-body {
    padding: 0.5rem !important;
}
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold">Project Plan Template</h1>
        
        <form id="projectForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="projectTitle">PROJECT TITLE:</label>
                    <input type="text" id="projectTitle" name="projectTitle">
                </div>
                <div>
                    <label for="whereRun">WHERE WILL THIS RUN?</label>
                    <input type="text" id="whereRun" name="whereRun">
                </div>
            </div>

            <div>
                <label for="businessProblem">WHAT'S THE BUSINESS PROBLEM THAT WE ARE TRYING TO SOLVE?</label>
                <textarea id="businessProblem" name="businessProblem" rows="3"></textarea>
            </div>

            <div>
                <label for="customerAction">WHAT ARE WE ASKING THE CUSTOMER/MANAGER TO DO?</label>
                <textarea id="customerAction" name="customerAction" rows="3"></textarea>
            </div>

            <div>
                <label for="defineWin">HOW DO WE DEFINE A WIN?</label>
                <textarea id="defineWin" name="defineWin" rows="3"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="primeProspect">WHO'S THE PRIME PROSPECT?</label>
                    <textarea id="primeProspect" name="primeProspect" rows="3"></textarea>
                </div>
                <div>
                    <label for="prospectProblem">WHAT'S THE PRIME PROSPECT'S PROBLEM?</label>
                    <textarea id="prospectProblem" name="prospectProblem" rows="3"></textarea>
                </div>
            </div>

            <div>
                <label for="knowBrand">KNOW THE BRAND</label>
                <textarea id="knowBrand" name="knowBrand" rows="3"></textarea>
            </div>

            <div>
                <label for="deliverables">Deliverable(s):</label>
                <textarea id="deliverables" name="deliverables" rows="3"></textarea>
            </div>

            <div>
                <h3 class="font-semibold mb-2 text-lg">RACI:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="responsible">R (Responsible):</label>
                        <input type="text" id="responsible" name="responsible">
                    </div>
                    <div>
                        <label for="accountable">A (Accountable):</label>
                        <input type="text" id="accountable" name="accountable">
                    </div>
                    <div>
                        <label for="consulted">C (Consulted):</label>
                        <input type="text" id="consulted" name="consulted">
                    </div>
                    <div>
                        <label for="informed">I (Informed):</label>
                        <input type="text" id="informed" name="informed">
                    </div>
                </div>
            </div>

            <div>
                <h3 class="font-semibold mb-2 text-lg">TIMING and TASKS</h3>
                <div id="taskToolbar" class="task-toolbar">
                    <span id="selectedCount" class="text-sm font-medium">0 selected</span>
                    <button type="button" id="duplicateSelected" class="toolbar-button bg-green-500">Duplicate Selected</button>
                    <button type="button" id="deleteSelected" class="toolbar-button bg-red-500">Delete Selected</button>
                </div>
                <table id="tasksTable">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" class="task-checkbox">
                            </th>
                            <th>Task</th>
                            <th>Owner</th>
                            <th>Due Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="taskTableBody">
                        <!-- Tasks will be added here dynamically -->
                    </tbody>
                </table>
                <button type="button" id="addTask" class="mt-4 bg-blue-500 text-white">Add Task</button>
            </div>

            <div>
                <label for="additionalNotes">Additional Notes:</label>
                <textarea id="additionalNotes" name="additionalNotes" rows="3"></textarea>
            </div>

            <div class="flex justify-between">
                <button type="submit" class="bg-green-500 text-white">Save</button>
                <button type="button" id="loadBtn" class="bg-yellow-500 text-white">Load</button>
                <button type="button" id="shareBtn" class="bg-blue-500 text-white">Share as PDF</button>
            </div>
        </form>
    </div>

     <script>
       // Initialize jsPDF
const { jsPDF } = window.jspdf;

// Get DOM elements
const taskTableBody = document.getElementById('taskTableBody');
const taskToolbar = document.getElementById('taskToolbar');
const selectedCountSpan = document.getElementById('selectedCount');
const selectAllCheckbox = document.getElementById('selectAll');

// Initialize TinyMCE
tinymce.init({
    selector: 'textarea:not([name="task[]"])',
    height: 300,
    menubar: false,
    plugins: [
        'anchor', 'autolink', 'charmap', 'codesample', 'emoticons',
        'link', 'lists', 'media', 'searchreplace', 'table',
        'visualblocks', 'wordcount', 'checklist', 'export',
        'formatpainter', 'pageembed', 'permanentpen', 'advtable',
        'advcode', 'editimage', 'tableofcontents'
    ],
    toolbar: 'undo redo | blocks fontfamily fontsize | ' +
        'bold italic underline strikethrough | link table | ' +
        'align lineheight | checklist numlist bullist indent outdent | ' +
        'removeformat',
    content_style: 'body { font-family: Arial, sans-serif; font-size: 14px }'
});

// Helper function for stripping HTML in PDF generation
function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
}

// Utility Functions
function updateToolbarVisibility() {
    const selectedTasks = document.querySelectorAll('input[name="taskSelect"]:checked');
    const count = selectedTasks.length;
    selectedCountSpan.textContent = `${count} selected`;
    taskToolbar.classList.toggle('visible', count > 0);
    selectAllCheckbox.checked = count === document.querySelectorAll('input[name="taskSelect"]').length;
}

function createTaskRow(task = '', owner = '', dueDate = '') {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" name="taskSelect" class="task-checkbox">
            <span class="task-drag-handle">☰</span>
        </td>
        <td>
            <input type="text" name="task[]" value="${task}">
        </td>
        <td><input type="text" name="owner[]" value="${owner}"></td>
        <td><input type="date" name="dueDate[]" value="${dueDate}"></td>
        <td><button type="button" class="delete-task">Delete</button></td>
    `;

    const checkbox = row.querySelector('input[name="taskSelect"]');
    checkbox.addEventListener('change', () => {
        row.classList.toggle('selected-row', checkbox.checked);
        updateToolbarVisibility();
        
        // Update Sortable selection when checkbox is changed
        if (checkbox.checked) {
            Sortable.utils.select(row);
        } else {
            Sortable.utils.deselect(row);
        }
    });

    row.querySelector('.delete-task').addEventListener('click', function() {
        if (taskTableBody.children.length > 1) {
            row.remove();
            updateToolbarVisibility();
        } else {
            alert("You can't delete the last task. At least one task is required.");
        }
    });

    return row;
}

// Event Listeners
selectAllCheckbox.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('input[name="taskSelect"]');
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        checkbox.checked = this.checked;
        row.classList.toggle('selected-row', this.checked);
        
        // Update Sortable selection
        if (this.checked) {
            Sortable.utils.select(row);
        } else {
            Sortable.utils.deselect(row);
        }
    });
    updateToolbarVisibility();
});
document.getElementById('duplicateSelected').addEventListener('click', function() {
    const selectedRows = document.querySelectorAll('input[name="taskSelect"]:checked');
    if (selectedRows.length === 0) return;

    // Find the last selected row
    const lastSelectedRow = Array.from(selectedRows).pop().closest('tr');
    
    // Create duplicates and insert them after the last selected row
    selectedRows.forEach(checkbox => {
        const originalRow = checkbox.closest('tr');
        const taskInput = originalRow.querySelector('input[name="task[]"]').value;
        const ownerInput = originalRow.querySelector('input[name="owner[]"]').value;
        const dueDateInput = originalRow.querySelector('input[name="dueDate[]"]').value;
        
        const newRow = createTaskRow(taskInput, ownerInput, dueDateInput);
        lastSelectedRow.parentNode.insertBefore(newRow, lastSelectedRow.nextSibling);
    });

    // Unselect all after duplication
    selectAllCheckbox.checked = false;
    selectedRows.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.closest('tr').classList.remove('selected-row');
    });
    updateToolbarVisibility();
});

document.getElementById('deleteSelected').addEventListener('click', function() {
    const selectedRows = document.querySelectorAll('input[name="taskSelect"]:checked');
    if (selectedRows.length === 0) return;

    const remainingRows = taskTableBody.children.length - selectedRows.length;
    if (remainingRows < 1) {
        alert("You must keep at least one task.");
        return;
    }

    selectedRows.forEach(checkbox => {
        checkbox.closest('tr').remove();
    });
    updateToolbarVisibility();
});

document.getElementById('addTask').addEventListener('click', function() {
    taskTableBody.appendChild(createTaskRow());
});

// Initialize with one empty task
taskTableBody.appendChild(createTaskRow());

// Initialize Sortable
new Sortable(taskTableBody, {
    animation: 150,
    handle: '.task-drag-handle',
    ghostClass: 'bg-gray-100',
    multiDrag: true,
    selectedClass: 'selected-row',
    fallbackTolerance: 3,
    onSelect: function(evt) {
        const checkbox = evt.item.querySelector('input[name="taskSelect"]');
        if (checkbox && !checkbox.checked) {
            checkbox.checked = true;
            updateToolbarVisibility();
        }
    },
    onDeselect: function(evt) {
        const checkbox = evt.item.querySelector('input[name="taskSelect"]');
        if (checkbox && checkbox.checked) {
            checkbox.checked = false;
            updateToolbarVisibility();
        }
    },
    setData: function(dataTransfer, dragEl) {
        const selectedCount = document.querySelectorAll('input[name="taskSelect"]:checked').length;
        if (selectedCount > 1) {
            dataTransfer.setDragImage(dragEl, 0, 0);
        }
    }
});

// PDF Generation code
document.getElementById('shareBtn').addEventListener('click', function() {
    const data = JSON.parse(localStorage.getItem('projectPlan'));
    if (data) {
        const doc = new jsPDF();
        let yPos = 20;

        // Set default font
        doc.setFont("helvetica");

        // Helper function to format date as MM/DD/YYYY
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
        }

// addSection function in the PDF generation code
function addSection(title, content) {
    doc.setFontSize(16);
    doc.setTextColor(44, 62, 80);
    doc.text(title, 20, yPos);
    yPos += 10;
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    
    // Parse HTML content
    const parser = new DOMParser();
    const html = parser.parseFromString(content, 'text/html');
    let processedText = '';
    
    // Process formatting
    html.body.childNodes.forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) {
            processedText += node.textContent + '\n';
        } else if (node.nodeType === Node.ELEMENT_NODE) {
            switch (node.nodeName.toLowerCase()) {
                case 'p':
                    processedText += node.textContent + '\n\n';
                    break;
                case 'strong':
                case 'b':
                    doc.setFont(undefined, 'bold');
                    processedText += node.textContent;
                    doc.setFont(undefined, 'normal');
                    break;
                case 'em':
                case 'i':
                    doc.setFont(undefined, 'italic');
                    processedText += node.textContent;
                    doc.setFont(undefined, 'normal');
                    break;
                case 'ul':
                case 'ol':
                    Array.from(node.children).forEach((li, index) => {
                        processedText += `  • ${li.textContent}\n`;
                    });
                    processedText += '\n';
                    break;
                default:
                    processedText += node.textContent + '\n';
            }
        }
    });

    // Split text into lines and add to PDF
    const lines = doc.splitTextToSize(processedText.trim(), 170);
    doc.text(lines, 20, yPos);
    yPos += lines.length * 7 + 10;

    if (yPos > 270) {
        doc.addPage();
        yPos = 20;
    }
}

        // Add title
        doc.setFontSize(24);
        doc.setTextColor(52, 152, 219);
        doc.text("Project Plan", 105, yPos, null, null, "center");
        yPos += 15;

        // Add project details to PDF
        addSection('Project Title:', data.projectTitle);
        addSection('Where will this run?', data.whereRun);
        addSection('Business Problem:', data.businessProblem);
        addSection('Customer/Manager Action:', data.customerAction);
        addSection('Define a Win:', data.defineWin);
        addSection('Prime Prospect:', data.primeProspect);
        addSection("Prime Prospect's Problem:", data.prospectProblem);
        addSection('Know the Brand:', data.knowBrand);
        addSection('Deliverables:', data.deliverables);

        // Add RACI
        addSection('RACI:', `R (Responsible): ${data.responsible}\nA (Accountable): ${data.accountable}\nC (Consulted): ${data.consulted}\nI (Informed): ${data.informed}`);

        // Add Tasks using autoTable
        doc.setFontSize(16);
        doc.setTextColor(44, 62, 80);
        doc.text('Tasks:', 20, yPos);
        yPos += 10;

        doc.autoTable({
            startY: yPos,
            head: [['Task', 'Owner', 'Due Date']],
            body: data.tasks.map(task => [
                task.task,
                task.owner,
                formatDate(task.dueDate)
            ]),
            theme: 'striped',
            headStyles: { fillColor: [52, 152, 219], textColor: 255 },
            columnStyles: {
                0: { cellWidth: 80 },
                1: { cellWidth: 50 },
                2: { cellWidth: 40 }
            }
        });

        yPos = doc.lastAutoTable.finalY + 10;
        addSection('Additional Notes:', data.additionalNotes);

        // Add page numbers
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Page ' + i + ' of ' + pageCount, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
        }

        // Generate filename based on project title
        let filename = data.projectTitle ? data.projectTitle.trim() : 'Project Plan';
        filename = filename.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.pdf';

        doc.save(filename);
    } else {
        alert('No project plan to share. Please save a plan first.');
    }
});

// Form submission handler
document.getElementById('projectForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Get all TinyMCE content first
    document.querySelectorAll('textarea:not([name="task[]"])').forEach(field => {
        const editor = tinymce.get(field.id);
        if (editor) {
            field.value = editor.getContent();
        }
    });

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    data.tasks = Array.from(formData.getAll('task[]')).map((task, index) => ({
        task,
        owner: formData.getAll('owner[]')[index],
        dueDate: formData.getAll('dueDate[]')[index]
    }));
    localStorage.setItem('projectPlan', JSON.stringify(data));
    alert('Project plan saved!');
});

// Load button handler
document.getElementById('loadBtn').addEventListener('click', function() {
    const data = JSON.parse(localStorage.getItem('projectPlan'));
    if (data) {
        Object.keys(data).forEach(key => {
            if (key !== 'tasks') {
                const el = document.getElementById(key);
                if (el) {
                    if (el.tagName.toLowerCase() === 'textarea') {
                        const editor = tinymce.get(el.id);
                        if (editor) {
                            editor.setContent(data[key]);
                        }
                    } else {
                        el.value = data[key];
                    }
                }
            }
        });
        taskTableBody.innerHTML = '';
        data.tasks.forEach(task => {
            taskTableBody.appendChild(createTaskRow(task.task, task.owner, task.dueDate));
        });
        updateToolbarVisibility();
        alert('Project plan loaded!');
    } else {
        alert('No saved project plan found!');
    }
});

// Auto-load saved data when page loads
window.addEventListener('DOMContentLoaded', function() {
    const savedData = localStorage.getItem('projectPlan');
    if (savedData) {
        const data = JSON.parse(savedData);
        Object.keys(data).forEach(key => {
            if (key !== 'tasks') {
                const el = document.getElementById(key);
                if (el) {
                    if (el.tagName.toLowerCase() === 'textarea') {
                        const editor = tinymce.get(el.id);
                        if (editor) {
                            editor.setContent(data[key]);
                        }
                    } else {
                        el.value = data[key];
                    }
                }
            }
        });
        taskTableBody.innerHTML = '';
        data.tasks.forEach(task => {
            taskTableBody.appendChild(createTaskRow(task.task, task.owner, task.dueDate));
        });
        updateToolbarVisibility();
    }
});
</script>
</body>
</html>
